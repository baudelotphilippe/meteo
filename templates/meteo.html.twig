{% extends 'base.html.twig' %}

{% block title %}MÃ©tÃ©o{% endblock %}

{% block body %}
<section class="container my-4">
    <h1 class="mb-4">MÃ©tÃ©o Ã  {{ ville }}</h1>
    <h2>{{ infosDay.date }}</h2>

    <p class="text-center">levÃ© {{infosDay.ephemeride.sunrise}} - couchÃ© {{infosDay.ephemeride.sunset}}</p>
    
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">
        {% for source in sources %}
            <div class="col">
                <div class="card h-100 d-flex flex-column justify-content-between">
                    <div class="card-body text-center">
                        <p class="fs-1 fw-bold mb-2">{{ source.temperature|round }} Â°C</p>
						<span class="weather-icon">{% if source.icon %}{{ source.icon }}{% endif %}</span>
                        {% if source.description %}
                            <p class="card-text mb-1">{{ source.description }}</p>
                        {% endif %}
						<div class="d-flex justify-content-between px-2 small pt-4">
							<span>HumiditÃ© : {{ source.humidity }} %</span>
							<span>Vent : {{ source.wind }} km/h</span>
						</div>
                    </div>
                    <div class="card-footer text-center">
                        <a href="{{ source.sourceUrl }}" target="_blank">
                            <img src="{{ source.logoUrl }}" alt="{{ source.sourceName }}" style="max-height: 30px;"><span class="ms-3 card-title">{{ source.provider }}</span>
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <h2>PrÃ©visions pour aujourd'hui</h2>
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>Source</th>
                    {% set allTimes = ['06h00','09h00','12h00','15h00','18h00','21h00'] %}
                    {% for time in allTimes %}
                        {% set hour = time|slice(0,2) + 0 %}
                        {% set nowHour = "now"|date("H") + 0 %}
                        <th class="{{ hour < nowHour ? 'past-hour' }}">
                            {{ time }}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for provider, forecasts in todayHourly %}
                    <tr>
                        <th class="text-start">{{ provider }}</th>
                        {% for time in allTimes %}
                            {% set found = forecasts|filter(f => f.time == time)|first %}
                            {% set hour = time|slice(0,2) + 0 %}
                            {% set nowHour = "now"|date("H") + 0 %}
                            <td class="{{ hour < nowHour ? 'past-hour' }}">
                                {% if found is not same as(false) %}
                                    <div class="weather-cell">
                                        <div class="weather-icon">{{ found.icon }}</div>
                                        <div class="fw-bold">{{ found.temperature|round }}Â°C</div>
                                        <div class="text-muted small">{{ found.description }}</div>
                                    </div>
                                {% else %}
                                    <div style="opacity: 0.3;">â€”</div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 class="mt-4">PrÃ©visions pour les prochains jours</h2>
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>Source</th>
					{% set firstForecasts = forecastRows|first %}
					{% if firstForecasts is iterable %}
						{% for i in 1..6 %}
							<th>{{ firstForecasts[i].date|jour_fr }}</th>
						{% endfor %}
					{% else %}
						<th colspan="7" class="text-muted">Pas de prÃ©visions disponibles</th>
					{% endif %}

                </tr>
            </thead>
            <tbody>
                {% for provider, forecasts in forecastRows %}
                    <tr>
                        <th class="text-start">{{ provider }}</th>
                        {% set prev = null %}
                        {% for forecast in forecasts|slice(1,7) %}
                            <td>
                                <div class="fw-bold">{{ forecast.tmin|round }}â€“{{ forecast.tmax|round }}Â°C</div>
                                {% if prev is not null %}
                                    {% set diff = forecast.tmax - prev %}
                                    {% if diff > 0.5 %}
                                        <span class="text-danger">ðŸ”º</span>
                                    {% elseif diff < -0.5 %}
                                        <span class="text-primary">ðŸ”»</span>
                                    {% else %}
                                        <span class="text-primary">=</span>
                                    {% endif %}
                                {% endif %}
                                {% if forecast.description %}
                                    <div class="text-muted small">{{ forecast.description }}</div>
                                {% endif %}
                            </td>
                            {% set prev = forecast.tmax %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
